[2025-02-20T23:59:08.179+0000] {taskinstance.py:1083} INFO - Dependencies all met for <TaskInstance: listenbrainz_pipeline_duckdb.upsert_dims manual__2025-02-20T23:57:44.074247+00:00 [queued]>
[2025-02-20T23:59:08.190+0000] {taskinstance.py:1083} INFO - Dependencies all met for <TaskInstance: listenbrainz_pipeline_duckdb.upsert_dims manual__2025-02-20T23:57:44.074247+00:00 [queued]>
[2025-02-20T23:59:08.190+0000] {taskinstance.py:1279} INFO - 
--------------------------------------------------------------------------------
[2025-02-20T23:59:08.190+0000] {taskinstance.py:1280} INFO - Starting attempt 1 of 2
[2025-02-20T23:59:08.190+0000] {taskinstance.py:1281} INFO - 
--------------------------------------------------------------------------------
[2025-02-20T23:59:08.208+0000] {taskinstance.py:1300} INFO - Executing <Task(PythonOperator): upsert_dims> on 2025-02-20 23:57:44.074247+00:00
[2025-02-20T23:59:08.214+0000] {standard_task_runner.py:55} INFO - Started process 358 to run task
[2025-02-20T23:59:08.217+0000] {standard_task_runner.py:82} INFO - Running: ['***', 'tasks', 'run', 'listenbrainz_pipeline_duckdb', 'upsert_dims', 'manual__2025-02-20T23:57:44.074247+00:00', '--job-id', '7', '--raw', '--subdir', 'DAGS_FOLDER/listenbrainz_dag.py', '--cfg-path', '/tmp/tmpxebgx3ki']
[2025-02-20T23:59:08.218+0000] {standard_task_runner.py:83} INFO - Job 7: Subtask upsert_dims
[2025-02-20T23:59:08.300+0000] {task_command.py:388} INFO - Running <TaskInstance: listenbrainz_pipeline_duckdb.upsert_dims manual__2025-02-20T23:57:44.074247+00:00 [running]> on host 80fe7ff0e0c3
[2025-02-20T23:59:08.390+0000] {taskinstance.py:1509} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_OWNER=***
AIRFLOW_CTX_DAG_ID=listenbrainz_pipeline_duckdb
AIRFLOW_CTX_TASK_ID=upsert_dims
AIRFLOW_CTX_EXECUTION_DATE=2025-02-20T23:57:44.074247+00:00
AIRFLOW_CTX_TRY_NUMBER=1
AIRFLOW_CTX_DAG_RUN_ID=manual__2025-02-20T23:57:44.074247+00:00
[2025-02-20T23:59:08.635+0000] {taskinstance.py:1768} ERROR - Task failed with exception
Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 1901, in _execute_context
    cursor, statement, parameters, context
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/default.py", line 736, in do_execute
    cursor.execute(statement, parameters)
  File "/home/airflow/.local/lib/python3.7/site-packages/duckdb_engine/__init__.py", line 163, in execute
    self.__c.execute(statement, parameters)
duckdb.duckdb.CatalogException: Catalog Error: Table with name dim_user does not exist!
Did you mean "sqlite_master"?

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.7/site-packages/airflow/operators/python.py", line 175, in execute
    return_value = self.execute_callable()
  File "/home/airflow/.local/lib/python3.7/site-packages/airflow/operators/python.py", line 192, in execute_callable
    return self.python_callable(*self.op_args, **self.op_kwargs)
  File "/opt/airflow/dags/listenbrainz_dag.py", line 62, in upsert_dimensions_task
    upsert_dimensions(engine)
  File "/opt/airflow/src/pipeline/unified_pipeline.py", line 155, in upsert_dimensions
    """))
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/future/engine.py", line 281, in execute
    statement, parameters, execution_options or NO_OPTIONS
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 1705, in _execute_20
    return meth(self, args_10style, kwargs_10style, execution_options)
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/sql/elements.py", line 335, in _execute_on_connection
    self, multiparams, params, execution_options
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 1582, in _execute_clauseelement
    cache_hit=cache_hit,
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 1944, in _execute_context
    e, statement, parameters, cursor, context
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 2125, in _handle_dbapi_exception
    sqlalchemy_exception, with_traceback=exc_info[2], from_=e
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/util/compat.py", line 211, in raise_
    raise exception
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/base.py", line 1901, in _execute_context
    cursor, statement, parameters, context
  File "/home/airflow/.local/lib/python3.7/site-packages/sqlalchemy/engine/default.py", line 736, in do_execute
    cursor.execute(statement, parameters)
  File "/home/airflow/.local/lib/python3.7/site-packages/duckdb_engine/__init__.py", line 163, in execute
    self.__c.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (duckdb.duckdb.CatalogException) Catalog Error: Table with name dim_user does not exist!
Did you mean "sqlite_master"?
[SQL: 
        INSERT INTO dim_user (user_sk, user_id)
        WITH new_users AS (
            SELECT DISTINCT user_id FROM stg_listens_dedup
        ),
        existing_max AS (
            SELECT COALESCE(MAX(user_sk), 0) AS max_sk FROM dim_user
        ),
        to_insert AS (
            SELECT
              (row_number() OVER (ORDER BY nu.user_id) + em.max_sk) AS new_sk,
               nu.user_id
            FROM new_users nu
            LEFT JOIN dim_user du ON nu.user_id = du.user_id
            CROSS JOIN existing_max em
            WHERE du.user_id IS NULL
        )
        SELECT new_sk, user_id FROM to_insert;
        ]
(Background on this error at: https://sqlalche.me/e/14/f405)
[2025-02-20T23:59:08.651+0000] {taskinstance.py:1323} INFO - Marking task as UP_FOR_RETRY. dag_id=listenbrainz_pipeline_duckdb, task_id=upsert_dims, execution_date=20250220T235744, start_date=20250220T235908, end_date=20250220T235908
[2025-02-20T23:59:08.664+0000] {standard_task_runner.py:105} ERROR - Failed to execute job 7 for task upsert_dims ((duckdb.duckdb.CatalogException) Catalog Error: Table with name dim_user does not exist!
Did you mean "sqlite_master"?
[SQL: 
        INSERT INTO dim_user (user_sk, user_id)
        WITH new_users AS (
            SELECT DISTINCT user_id FROM stg_listens_dedup
        ),
        existing_max AS (
            SELECT COALESCE(MAX(user_sk), 0) AS max_sk FROM dim_user
        ),
        to_insert AS (
            SELECT
              (row_number() OVER (ORDER BY nu.user_id) + em.max_sk) AS new_sk,
               nu.user_id
            FROM new_users nu
            LEFT JOIN dim_user du ON nu.user_id = du.user_id
            CROSS JOIN existing_max em
            WHERE du.user_id IS NULL
        )
        SELECT new_sk, user_id FROM to_insert;
        ]
(Background on this error at: https://sqlalche.me/e/14/f405); 358)
[2025-02-20T23:59:08.709+0000] {local_task_job.py:208} INFO - Task exited with return code 1
[2025-02-20T23:59:08.780+0000] {taskinstance.py:2578} INFO - 0 downstream tasks scheduled from follow-on schedule check
